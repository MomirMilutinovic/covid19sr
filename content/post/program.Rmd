---
title: "COVID-19 SR Visualisation in R"
author: Tatjana Kecojevic
date: "`r Sys.Date()`"
slug: programme
categories: []
tags:
  - rststs
  - covid19
  - corona
comments: yes
image: ''
menu: ''
share: yes
---

```{r setup, include=FALSE, message = FALSE, warning = FALSE, include = FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include=TRUE,
                      prompt = TRUE,
                      message = FALSE,
                      warning = FALSE,
                      cache = FALSE)
```

This is a data analysis report concerning the visualisation of the COVID-19 virus within the Republic of Serbia. All of the report is created with [R](https://www.r-project.org). The data used for the analysis is sourced from the [Portal of Open Data of Republic of Serbia](https://data.gov.rs/sr/datasets/covid-19-zarazheni/?fbclid=IwAR1nX00zb9p_ceNfBoxQaObyjI8XsMWEIKj2NYGhnTf2xAh6oMsvvmnbSoQ). To learn how to use R and develop a report like this visit [Intro to DS Bootcamp in R](http://dsbootcamp.rbind.io/).

This is a [Sister Analyst](https://sisteranalyst.org/) project. 


```{r, echo=FALSE, message = FALSE, warning = FALSE, results = FALSE}
library(readxl)
library(tidyverse)
library(writexl)
library(httr)
library(forcats)
library(lubridate)
library(ggplot2)
library(gganimate)
library(dplyr)
library(leaflet)
library(plotly)
library(scales)

url1 <- "https://data.gov.rs/s/resources/covid-19-zarazheni/20200330-200441/covid-19.xlsx"
# https://data.gov.rs/sr/datasets/r/1977833a-36f2-445e-916a-ef51b217d3a0

GET(url1, 
    write_disk(tf <- tempfile(fileext = ".xlsx")))

covidserbia <- read_excel(tf)
str(covidserbia)

#importing longitude and latitude
towns <- read.csv("SRlonglat.csv")

Date <- as.Date(with(covidserbia, paste(Godina, Mesec, Dan, sep="-")), "%Y-%m-%d")

mydata <- covidserbia %>% 
  rename(Year = Godina) %>% 
  rename(Month = Mesec) %>% 
  rename(Day = Dan) %>% 
  rename(Town = NazivTeritorije) %>% 
  rename(Cases = Vrednost) %>% 
  mutate(Date = Date) %>% 
  mutate(Town = fct_recode(Town, 
                           "ČAČAK" = "ČAČAK-GRAD",
                           "JAGODINA" = "JAGODINA-GRAD",
                           "KIKINDA" = "KIKINDA-GRAD",
                           "KRAGUJEVAC" = "KRAGUJEVAC-GRAD", 
                           "KRUŠEVAC" = "KRUŠEVAC-GRAD", 
                           "LESKOVAC" = "LESKOVAC-GRAD",
                           "LOZNICA" = "LOZNICA-GRAD", 
                           "NOVI PAZAR" = "NOVI PAZAR-GRAD",
                           "PANČEVO" = "PANČEVO-GRAD", 
                           "PRIŠTINA" = "PRIŠTINA-GRAD",
                           "PIROT" = "PIROT-GRAD",
                           "ŠABAC" = "ŠABAC-GRAD", 
                           "SMEDEREVO" = "SMEDEREVO-GRAD",
                           "SOMBOR" = "SOMBOR-GRAD",
                           "SREMSKA MITROVICA" = "SREMSKA MITROVICA-GRAD",
                           "SUBOTICA" = "SUBOTICA-GRAD",
                           "VALJEVO" = "VALJEVO-GRAD",
                           "VRŠAC" = "VRŠAC-GRAD",
                           "ZAJEČAR" = "ZAJEČAR-GRAD",
                           "ZRENJANIN" = "ZRENJANIN-GRAD", 
                           "KRALJEVO" = "KRALJEVO-GRAD"))

mydata <- mydata %>% 
  filter(Town != "Republika Srbija")

mydata <- left_join(mydata, towns, by = "Town")


mydata <- mydata[, -c(1, 3, 8)]
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

k <- 174 # there are 174 towns
# how many days?
rown <- dim(mydata)[1] + (2*k)  
# x:sequence of the blocks
x <- seq(1, rown, k)
# l:how many blocks
l <- rown/k - 2

# ~~~ inew cases ~~~
mydcase <- mydata[(x[1]:(k*1)),] # 1st block
# block for 07-March-2020
mydcase <- rbind(mydcase, mydata[(x[1]:(k*1)),])
mydcase$Day[(x[2]:(x[3]-1))] <- rep(7, k)
mydcase$Date[(x[2]:(x[3]-1))] <- rep(as.Date("2020-3-7", "%Y-%m-%d"), k)
# block for 08-March-2020
mydcase <- rbind(mydcase, mydata[(x[1]:(k*1)),])
mydcase$Day[(x[3]:(x[4]-1))] <- rep(8, k)
mydcase$Date[(x[3]:(x[4]-1))] <- rep(as.Date("2020-3-8", "%Y-%m-%d"), k)
# blocks from 09-March-2020
for (i in seq(3, l-1, by = 2)) {
  mydcase <- rbind(mydcase, mydata[x[i]:(k*i), ]) 
}
#dim(mydcase)

# ~~~ cumulative cases ~~~
mydtotal <- mydata[(x[2]:(k*2)),] # 1st block

# block for 07-March-2020
mydtotal <- rbind(mydtotal, mydata[(x[2]:(k*2)),])
mydtotal$Day[(x[2]:(x[3]-1))] <- rep(7, k)
mydtotal$Date[(x[2]:(x[3]-1))] <- rep(as.Date("2020-3-7", "%Y-%m-%d"), k)
# block for 08-March-2020
mydtotal <- rbind(mydtotal, mydata[(x[2]:(k*2)),])
mydtotal$Day[(x[3]:(x[4]-1))] <- rep(8, k)
mydtotal$Date[(x[3]:(x[4]-1))] <- rep(as.Date("2020-3-8", "%Y-%m-%d"), k)
for (i in seq(4, l, by = 2)) {
  mydtotal <- rbind(mydtotal, mydata[x[i]:(k*i), ]) 
}
#dim(mydtotal)
```


## Mapping the Cases

```{r, echo=FALSE}
tl <- dim(mydtotal)[1]
last_day <- mydtotal[(tl-k+1):tl,]

last_day_map <- last_day %>% 
  filter(Cases != 0) %>% 
  group_by(Town)

mdata <- last_day_map %>%
  arrange(Cases) %>%
  mutate(name = factor(Town, unique(Town))) %>%
  mutate( mytext = paste(
    "Town: ", name, "\n", 
    "Cases: ", Cases, sep = "")
  )

SR <- map_data("world") %>% filter(region=="Serbia")
  
p <-
  ggplot() +
  geom_polygon(data = SR, aes(x=long, y = lat, group = group), fill="grey", alpha=0.3) +
  geom_point(data = mdata, aes(x=lng, y=lat, size=Cases, color=Cases, text=mytext, alpha = 0.3)) + 
  scale_size_continuous(range=c(1,15)) +
  #scale_color_viridis_d(option="inferno") +
  scale_alpha_continuous(trans="log") +
  theme_void() +
  ylim(42,47) +
  coord_map() +
  theme(legend.position = "right")

p <- ggplotly(p, tooltip="text")
p
```

```{r, echo=FALSE}
ts <- last_day_map %>% 
  select(Town, Cases) %>% 
  arrange(desc(Cases)) %>% 
  DT::datatable()

widgetframe::frameWidget(ts)
```


## Total Number of Cases by Day

```{r, echo = FALSE}
mydt <- mydtotal %>% 
  drop_na() %>% 
  group_by(Date) %>% 
  arrange(Date) %>% 
  summarise(total = sum(Cases))

# Bar Chart: Total number of cases for each day
mydt %>% 
  ggplot(aes(x = Date, y = total)) +
     geom_bar(stat="identity", fill = "#00688B", color = "black") + 
     theme(plot.title = element_text(size = 14, vjust = 2, hjust=0.5)) +
     labs (title = "Total Number of Cases by Day", 
                     caption = "Data from: https://data.gov.rs", 
                     x = "Date", y = "Number of Cases") +
     theme_bw() +
     theme(legend.position="none") +
     theme(axis.text.x = element_text(angle = 90)) +
     scale_x_date(labels = date_format("%m-%d"),
                  breaks = 'day') 

# Data Table: Total number of cases for each day 
ts <- mydt %>%
  DT::datatable()

widgetframe::frameWidget(ts)
```

## Growth Rate of New Cases Day by Day
 
The number of registered cases at the beginning of the monitoring for covid-19 in Serbia was very small, starting from 1 on 06-March-202 and increasing by a few in the first week, reflecting in the high growth rate for those days. For example, from the first case reported on 6th March to the fourth on 9th March there is a difference of three, which gives 300% growth rate. For that reason the following graph includes growth rate figures starting from 12-March, whilst the table includes the full set of figures. 


```{r, echo=FALSE}  
# Growth rate day-by-day
growth_rate <- mydt %>%
  arrange(Date) %>%
  mutate(Diff_growth = total - lag(total), # Difference in route between years
         Rate_percent = round(Diff_growth/lag(total) * 100, 2))
  
gr_l <- dim(growth_rate)[1]

growth_rate[7:gr_l,]  %>% 
  ggplot(aes(x = Date, y = Rate_percent)) + 
  geom_line() + geom_point(col = "red") +
  xlab("Date") + ylab("Percentage Growth") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_date(labels = date_format("%m-%d"),
               breaks = 'day') 

ts <- growth_rate %>% DT::datatable()

widgetframe::frameWidget(ts)
```



## New Daily Cases

### Animation

```{r, echo = FALSE, fig.high = 20, fig.width = 10}
data_plot <- mydcase %>% 
  filter(Cases != 0) %>% 
  group_by(Town)

maxT <- max(data_plot$Cases)

ggplot(data_plot, aes(x = Town, y = Cases, fill = Town)) +
  geom_hline(yintercept = 0.05, colour = "#D3D3D3", linetype = "dashed") +
  geom_bar(position = "dodge", stat = "identity", color = "black") +
  geom_text(aes(label = Cases, y = Cases + 2),
            position = position_dodge(width = 0.2), 
            size = 4, color = "black") +
  coord_flip() +
  #theme(axis.text.x = element_text(angle = 90)) +  
  #theme(legend.position = "bottom", 
  #        axis.text.x = element_blank(),
  #        axis.ticks.x = element_blank()) + 
  labs(title = "COVID-19 SR",
       subtitle = "Number of new cases by Date {closest_state}",
       caption = "data from: https://data.gov.rs",
       x = "towns", y = "no new cases") +
  theme_bw() +
  scale_colour_brewer(palette = "Spectral") +
  #scale_fill_distiller()
  #  theme_light(base_size = 12) +
  #  scale_fill_brewer(palette="Dark2") + 
  guides(fill = FALSE) +
  scale_y_continuous(labels = waiver(), limits = c(0, maxT+3)) +
  transition_states(Date, 1, 3, wrap = FALSE) +
  ease_aes('quadratic-in-out')

#anim_save("Bars_H.gif")
```

### Table

The following table shows the number of new cases for each day in each town. You can use the text box in the top right corner to fillter the table by town.

```{r, echo = FALSE}
ts <- mydcase %>% 
  select(Town, Date, Cases) %>% 
  arrange(Town) %>% 
  DT::datatable()

widgetframe::frameWidget(ts)
```

## Total Number of Cases

### Animation


```{r, echo = FALSE, fig.high = 20, fig.widt = 10}
data_plot <- mydtotal %>% 
  filter(Cases != 0) %>% 
  group_by(Town)

maxT <- max(data_plot$Cases)

ggplot(data_plot, aes(x = Town, y = Cases, fill = Town)) +
  geom_hline(yintercept = 0.05, colour = "#D3D3D3", linetype = "dashed") +
  geom_bar(position = "dodge", stat = "identity", color = "black") +
  geom_text(aes(label = Cases, y = Cases + 3),
            position = position_dodge(width = 0.2), 
            size = 4, color = "black") +
  coord_flip() +
  #theme(axis.text.x = element_text(angle = 90)) +  
  #theme(legend.position = "bottom", 
  #        axis.text.x = element_blank(),
  #        axis.ticks.x = element_blank()) + 
  labs(title = "COVID-19 SR",
       subtitle = "Number of new cases by Date {closest_state}",
       caption = "data from: https://data.gov.rs",
       x = "towns", y = "no new cases") +
  theme_bw() +
  scale_colour_brewer(palette = "Spectral") +
  #scale_fill_distiller()
  #  theme_light(base_size = 12) +
  #  scale_fill_brewer(palette="Dark2") + 
  guides(fill = FALSE) +
  scale_y_continuous(labels = waiver(), limits = c(0, maxT+3)) +
  transition_states(Date, 1, 3, wrap = FALSE) +
  ease_aes('quadratic-in-out')

#anim_save("Bars_H.gif")
```

### Table

Table below shows cumulative number of cases for each day and each town. Use the top right handside textbox to filter the table by town.
```{r, echo = FALSE}
ts <- mydtotal %>% 
  select(Town, Date, Cases) %>% 
  arrange(Town) %>% 
  DT::datatable()

widgetframe::frameWidget(ts)
```

---

**Sisters in action:** [Tatjana Kecojević](https://www.linkedin.com/in/tatjana-kecojevic-803704143/), [Tijana Blagojev](https://www.linkedin.com/in/tijana-blagojev-288b3442/), [Jovana Savić](https://www.linkedin.com/in/jovana-savi%C4%87-12aa305a/), [Katarina Kosimina](https://www.linkedin.com/in/kosmina/) and [Anđela Milivojević](https://www.linkedin.com/in/andjela-milivojevic/) 🙌💜
